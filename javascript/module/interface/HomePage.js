define(["require","mustache","lib/InheritHelper","lib/BrowserUtil","lib/DateTimeUtil","module/agent/HomePageAgent","module/agent/FileManagePageAgent","module/component/StatusCodeManager","module/component/TemperatureManager","module/interface/CentreContentPage","module/interface/kit/Loader","module/interface/kit/AlertBox","module/GlobalVar","text!../../../html/HomePage.html","text!../../../html/homePage/ControlPanel.html","text!../../../html/homePage/StatusPanel.html","text!../../../html/homePage/ControlSvg.html","text!../../../html/homePage/reprintableTable/TableBody.html"],function(e){"use strict";function b(){this.superClass()}var t=e("mustache"),n=e("lib/InheritHelper"),r=e("lib/BrowserUtil"),i=e("lib/DateTimeUtil"),s=e("module/agent/HomePageAgent"),o=e("module/agent/FileManagePageAgent"),u=e("module/component/StatusCodeManager"),a=e("module/component/TemperatureManager"),f=e("module/interface/CentreContentPage"),l=e("module/interface/kit/Loader"),c=e("module/interface/kit/AlertBox"),h=e("module/GlobalVar"),p=e("text!../../../html/HomePage.html"),d=e("text!../../../html/homePage/ControlPanel.html"),v=e("text!../../../html/homePage/StatusPanel.html"),m=e("text!../../../html/homePage/ControlSvg.html"),g=e("text!../../../html/homePage/reprintableTable/TableBody.html"),y=4;return n.inheritPrototype(b,f),b.prototype.INDEX=0,b.prototype.active=function(){this._temperatureManager.repaintSize()},b.prototype.getContent=function(){var e=h.language.HomePage,n={BedTargetTemperatureText:e.BedTargetTemperature,BedTemperatureText:e.BedTemperature,ExtruderTargetTemperatureText:e.ExtruderTargetTemperature,ExtruderTemperatureText:e.ExtruderTemperature,bedTargetTemperatureColor:a.prototype.BedTargetTemperatureColor,bedTemperatureColor:a.prototype.BedTemperatureColor,extruderTargetTemperatureColor:a.prototype.ExtruderTargetTemperatureColor,extruderTemperatureColor:a.prototype.ExtruderTemperatureColor};return t.render(p,{TemperatureInfoText:e.TemperatureInfo,GCodeControlText:e.GCodeControl,temperaturesInfo:n,MostFunControlPanelText:e.MostFunControlPanel,ControlPanel:t.render(d,{controlSvg:m,LevellingButtonText:e.Levelling,temperaturesInfo:n}),StatusPanel:t.render(v,{CurrentPrintFileText:e.CurrentPrintFile,CurrentPrintLayerText:e.CurrentPrintLayer,PrintLayerCountText:e.PrintLayerCount,SaveButtonText:h.language.SettingPage.Save,PauseButtonText:e.Pause,CancelButtonText:e.Cancel,ResumeButtonText:e.Resume}),SendButtonText:e.Send,ReprintableTableText:e.ReprintableTable,ReprintableFileNameText:e.ReprintableFileName,ReprintableFileCreatedDateText:e.ReprintableFileCreatedDate,ReprintableFileOperateText:e.ReprintableFileOperate})},b.prototype._init=function(){this._initChart(),this.disable(!1),h.isMobile&&($("#temperatureChart").hide(),$("#controlPanel").hide(),$("#gCodeControlPanel").hide()),this._initUpdateTimer(),this._bindEvent(),this.updataReprintTable()},b.prototype._initChart=function(){var e=this,t=this._temperatureManager;setTimeout(function(){t.repaintSize();for(var e=0,n=20;e<n;++e)t.addData({bedTemperature:0,bedSettingTemperature:0,e0Temperature:0,e0SettingTemperature:0,time:"hh/mm/ss"});setTimeout(function(){t.repaintSize()},2e3)},1200)},b.prototype.updataReprintTable=function(){var e=h.language.HomePage,n=this;$("#reprintableTableFooter").html(l.getDiv());if(h.debug){$("#reprintableTableBody").html(t.render(g,{reprintItems:[{name:"test1",date:"1970.2.2",flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel},{name:"test2",date:"1970.2.2",flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel}]})),$("#reprintableTableFooter").html(""),this._bindReprintableTableEvent();return}o.queryFile("backlist",function(r){var i=JSON.parse(r),s=[],o=null;if(0===i.length){$("#reprintableTableRow").hide();return}for(var u=0,a=i.length;u<a;++u)o=i[u],s.push({name:o.fileName,date:o.fileTime,flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel});$("#reprintableTableBody").html(t.render(g,{reprintItems:s})),$("#reprintableTableFooter").html(""),n._bindReprintableTableEvent()},function(e){n.notifyErrorMessage(e.status)})},b.prototype._bindReprintableTableEvent=function(){var e=h.language.AlertBox,t=this;$(".ReprintButton").each(function(){$(this).click(function(n){var i={filename:$(this).closest("tr").data("filename"),path:$(this).closest("tr").data("flag")};r.stopPropagation(n),o.operateFiles("/print/",i,function(n){var r=JSON.parse(n);if(u.isOK(r.code)){t.updataReprintTable();return}var i=new c(e.PrintFileError);$("body").append(i.getDiv())},function(e){t.notifyErrorMessage(e.status)})})}),$(".CancelReprintButton").each(function(){$(this).click(function(e){r.stopPropagation(e);var n={filename:$(this).closest("tr").data("filename")};o.operateFiles("/cancel-task",n,function(e){t.updataReprintTable()},function(e){t.notifyErrorMessage(e.status)})})})},b.prototype._initUpdateTimer=function(){var e=this._temperatureManager,t=!1,n=this;if(h.debug)var r={state:"printing",details:{fileName:"testFileName",layerNum:"layerNumber",layerCount:"90"}};var o=0;setInterval(function(){if(h.debug){$("#gcodeLogWindow").prepend("["+i.formatDateToTime(new Date)+"] "+ ++o+" test<br>");if("ready"===r.state){if(!t)return;t=!1,$("#statusPanel").hide(),h.isMobile||$("#controlPanel").show(),$("#reprintableTableRow").show(),n.updataReprintTable();return}$("#currentPrintFile").html(r.details.fileName),$("#currentPrintLayer").html(r.details.layerNum),$("#printLayerCount").html(r.details.layerCount);if(t)return;t=!0,$("#controlPanel").hide(),$("#statusPanel").show(),$("#reprintableTableRow").hide();return}s.queryGCodeLog(function(e){var t=JSON.parse(e);if(0===t.result.length)return;$("#gcodeLogWindow").prepend("["+i.formatDateToTime(new Date)+"] "+t.result+"<br>")},function(e){n.notifyErrorMessage(e.status)}),s.queryPrint("temperature",function(t){e.updateData(t)},function(e){n.notifyErrorMessage(e.status)}),s.queryPrint("state",function(e){var r=JSON.parse(e).msg;if("error"==r.state){var i=new c(h.language.AlertBox.HardwareError);$("body").append(i.getDiv());return}"updating"===r.state&&(window.location.href="waiting-update");if("ready"===r.state){if(!t)return;t=!1,$("#statusPanel").hide(),h.isMobile||$("#controlPanel").show(),$("#reprintableTableRow").show(),n.updataReprintTable();return}$("#currentPrintFile").html(r.details.fileName),$("#currentPrintLayer").html(r.details.layerNum),$("#printLayerCount").html(r.details.layerCount);if(t)return;t=!0,$("#controlPanel").hide(),$("#statusPanel").show(),$("#reprintableTableRow").hide()},function(e){n.notifyErrorMessage(e.status)})},3e3)},b.prototype._bindEvent=function(){this._bindControlPanelEvent(),this._bindStatusPanelEvent()},b.prototype._bindControlPanelEvent=function(){var e=this;$("#levellingPlatformButton").click(function(t){r.stopPropagation(t),s.operatePrint("/auto-leveling",function(e){var t=JSON.parse(e);if(u.isOK(t.code))return;var n=new c(u.getErrorMessage(t.code));$("body").append(n.getDiv())},function(t){e.notifyErrorMessage(t.status)})}),$("#sendPanelCmdButton").click(function(){s.sendCmd($("#panelCmdText").val(),function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#activeBedTemperature").click(function(t){r.stopPropagation(t);if(!this.checked){s.sendCmd($("#bedTemperatureSlider").data("cmd")+"0",function(){},function(t){e.notifyErrorMessage(t.status)});return}s.sendCmd($("#bedTemperatureSlider").data("cmd")+$("#bedTemperatureSlider").val(),function(){},function(t){e.notifyErrorMessage(t.status)})}),$("#activeExtruderTemperature").click(function(t){r.stopPropagation(t);if(!this.checked){s.sendCmd($("#extruderTemperatureSlider").data("cmd")+"0",function(){},function(t){e.notifyErrorMessage(t.status)});return}s.sendCmd($("#extruderTemperatureSlider").data("cmd")+$("#extruderTemperatureSlider").val(),function(){},function(t){e.notifyErrorMessage(t.status)})}),$(".temperaturesSlider").each(function(){$(this).mouseup(function(t){if(!document.getElementById($(this).data("checkboxid")).checked)return;var n=$("#"+$(this).data("inputid"));s.sendCmd(n.data("cmd")+n.val(),function(){},function(t){e.notifyErrorMessage(t.status)})})}),$(".temperatureInput").each(function(){$(this).change(function(){if(!document.getElementById($(this).data("checkboxid")).checked)return;s.sendCmd($(this).data("cmd")+$(this).val(),function(){},function(t){e.notifyErrorMessage(t.status)})})}),$(".controlPanelButton").each(function(){$(this).click(function(t){r.stopPropagation(t);var n=$(this).data("cmd");s.sendCmd("G91",function(){s.sendCmd(n,function(e){})},function(t){e.notifyErrorMessage(t.status)})})})},b.prototype._bindStatusPanelEvent=function(){var e=this;$("#savePrintButton").click(function(){s.operatePrint("/save-task",function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#pausePrintButton").click(function(){s.operatePrint("/pause",function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#resumePrintButton").click(function(){s.operatePrint("/resume",function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#cancelPrintButton").click(function(){s.operatePrint("/cancel",function(e){},function(t){e.notifyErrorMessage(t.status)})})},b.prototype.update=function(){var e=new Date,t=null;if(h.debug){t={bedTemperature:Math.floor(Math.random()*60)+14,bedSettingTemperature:220,e0Temperature:Math.floor(Math.random()*60)+14,e0SettingTemperature:150},this._temperatureManager.addData({bedTemperature:t.bedTemperature,bedSettingTemperature:220,e0Temperature:t.e0Temperature,e0SettingTemperature:150,time:e.getMinutes()+":"+e.getSeconds()}),this._temperatureManager.repaintSize(),$("#bedTargetTemperature").html(220),$("#bedTemperature").html(t.bedTemperature),$("#extruderTargetTemperature").html(150),$("#extruderTemperature").html(t.e0Temperature);return}this._temperatureManager.repaintData(e),this._temperatureManager.repaintSize(),t=this._temperatureManager.getTemperatures(),$("#bedTargetTemperature").html(t.bedTargetTemperature),$("#bedTemperature").html(t.bedTemperature),$("#extruderTargetTemperature").html(t.extruderTargetTemperature),$("#extruderTemperature").html(t.extruderTemperature)},b});