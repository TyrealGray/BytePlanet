define(["require","mustache","module/interface/CentreContentPage","lib/InheritHelper","lib/BrowserUtil","module/component/StatusCodeManager","module/interface/kit/AlertBox","module/interface/kit/Loader","module/agent/SettingPageAgent","module/GlobalVar","text!../../../html/SettingPage.html","text!../../../html/settingPage/PasswordSetting.html","text!../../../html/settingPage/FirmwareSetting.html","text!../../../html/settingPage/EmailSetting.html","text!../../../html/settingPage/WifiSetting.html","text!../../../html/settingPage/LanguageSetting.html","text!../../../html/settingPage/availableWifiTable/TableBody.html","text!../../../html/settingPage/wifiConnect/WifiOperateModal.html"],function(e){"use strict";function b(){this.superClass(),this._bindEvent()}var t=e("mustache"),n=e("module/interface/CentreContentPage"),r=e("lib/InheritHelper"),i=e("lib/BrowserUtil"),s=e("module/component/StatusCodeManager"),o=e("module/interface/kit/AlertBox"),u=e("module/interface/kit/Loader"),a=e("module/agent/SettingPageAgent"),f=e("module/GlobalVar"),l=e("text!../../../html/SettingPage.html"),c=e("text!../../../html/settingPage/PasswordSetting.html"),h=e("text!../../../html/settingPage/FirmwareSetting.html"),p=e("text!../../../html/settingPage/EmailSetting.html"),d=e("text!../../../html/settingPage/WifiSetting.html"),v=e("text!../../../html/settingPage/LanguageSetting.html"),m=e("text!../../../html/settingPage/availableWifiTable/TableBody.html"),g=e("text!../../../html/settingPage/wifiConnect/WifiOperateModal.html"),y=null;return r.inheritPrototype(b,n),b.prototype.INDEX=3,b.prototype.active=function(){this._upgradableCheck(),this._emailSettingUpdate(),null===y&&this._getCurrentWifi()},b.prototype._upgradableCheck=function(){var e=this;a.queryData("/get-version",function(e){var t=JSON.parse(e);$("#curPanelVersion").html(t.panel),$("#curSystemVersion").html(t.system)},function(t){e.notifyErrorMessage(t.status)})},b.prototype._emailSettingUpdate=function(){var e=this;a.queryData("/get-mail-setting",function(e){var t=JSON.parse(e);$("#hostEmail").val(t.mail_from),$("#hostEmailPassword").val(t.mail_password),$("#hostServer").val(t.mail_server),$("#hostServerPort").val(t.mail_port),$("#emailPrefix").val(t.mail_prefix),$("#receiveEmail").val(t.mai_to)},function(t){e.notifyErrorMessage(t.status)})},b.prototype._getCurrentWifi=function(){var e=this;a.queryData("/get-current-wifi",function(e){var t=JSON.parse(e);$("#curWifiName").html(t.ssid+"("+t.ip+")")},function(t){$("#curWifiName").html(s.getErrorMessage(t.status)),e.notifyErrorMessage(t.status)})},b.prototype._bindEvent=function(){this._bindPasswordPageEvent(),this._bindFirmwarePageEvent(),this._bindEmailPageEvent(),this._bindWifiPageEvent(),this._bindLanguagePageEvent()},b.prototype._bindPasswordPageEvent=function(){var e=this;$("#savePasswordButton").click(function(t){i.stopPropagation(t);var n={old_password:$("#oldPassword").val(),new_password:$("#newPassword").val(),rpt_password:$("#confirmPassword").val()};a.changePassword(n,function(e){var t=JSON.parse(e);if(!s.isOK(t.code)){console.error("Unable to change password!");return}window.location.href=t.msg},function(t){e.notifyErrorMessage(t.status)})})},b.prototype._bindFirmwarePageEvent=function(){var e=this;$("#firmwareUpdateButton").click(function(t){a.queryData("/chk-update",function(t){var n=JSON.parse(t),r={system_update:n.system_update,panel_update:n.panel_update,marlin_update:n.marlin_update};a.updateFirmware(r,function(e){},function(t){e.notifyErrorMessage(t.status)})},function(t){e.notifyErrorMessage(t.status)})})},b.prototype._bindEmailPageEvent=function(){var e=this;$("#saveEmailButton").click(function(t){i.stopPropagation(t);var n={mail_from:$("#hostEmail").val(),mail_password:$("#hostEmailPassword").val(),mail_server:$("#hostServer").val(),mail_port:$("#hostServerPort").val(),mail_prefix:$("#emailPrefix").val(),mail_to:$("#receiveEmail").val()};a.changeEmail(n,function(t){var n=JSON.parse(t);if(!s.isOK(n.code)){e.notifyErrorMessage(n.code);return}},function(t){e.notifyErrorMessage(t.status)})})},b.prototype._bindWifiPageEvent=function(){var e=this;$("#saveRouterSettingButton").click(function(t){i.stopPropagation(t);var n={ssid:$("#routerName").val(),password:$("#routerPassword").val()};a.changeRouter(n,function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#getAvailableWifiButton").click(function(t){i.stopPropagation(t),$("#wifiTableFooter").html(u.getDiv()),$("#availableWifiTableBody").html("");if(f.debug){var n=[{ssid:"name",numberID:2,db:-8,secure:"secure"}];e._setWifiListTable(n);return}a.queryData("/get-wireless-list",function(t){var n=JSON.parse(t);e._setWifiListTable(n)},function(t){e.notifyErrorMessage(t.status)})})},b.prototype._setWifiListTable=function(e){var n=[],r=null,s=this;for(var o=0,u=e.length;o<u;++o)r=e[o],n.push({name:r.ssid,numberID:o,strength:(100+parseFloat(r.db)).toFixed(2),protocol:r.secure,connectText:f.language.SettingPage.Connect});$("#wifiTableFooter").html(""),$("#availableWifiTableBody").html(t.render(m,{wifiItems:n})),$(".ConnectWifiButton").each(function(){$(this).click(function(e){i.stopPropagation(e),s._onConnectButtonClick($(this).closest("tr").data("wifiname"),$(this).closest("tr").data("numberid"),$(this).closest("tr").data("protocol"))})})},b.prototype._onConnectButtonClick=function(e,n,r){var i=f.language.SettingPage;$("#mainModalContent").html(t.render(g,{ConnectText:i.Connect,SaveButtonText:i.Save,wifiNameText:e})),this._bindWifiConnectModalEvent(e,n,r),$("#mainModal").foundation("open")},b.prototype._bindWifiConnectModalEvent=function(e,t,n){var r=this;$("#wifi_ConnectButton").click(function(s){clearTimeout(y),i.stopPropagation(s);var o={ssid:e,number:t,secure:n,password:$("#wifiPassword").val()};a.connectWifi(o,function(e){},function(e){r.notifyErrorMessage(e.status)}),$("#mainModal").foundation("close"),$("#curWifiName").html(u.getDiv()),y=setTimeout(function(){r._getCurrentWifi(),y=null},25e3)})},b.prototype._bindLanguagePageEvent=function(){var e=this;$("#saveLanguageButton").click(function(t){i.stopPropagation(t),$(".languageSetting").each(function(){if(!this.checked)return;var t={lang:$(this).val()};localStorage.setItem("locale",t.lang),a.changeLanguage(t,function(e){},function(t){e.notifyErrorMessage(t.status)}),location.reload(!0)})})},b.prototype.getContent=function(){var e=f.language.SettingPage;return t.render(l,{SettingText:e.Setting,PasswordSettingText:e.PasswordSetting,FirmwareSettingText:e.FirmwareSetting,EmailSettingText:e.EmailSetting,WifiSettingText:e.WifiSetting,passwordSetting:t.render(c,{OldPasswordText:e.OldPassword,NewPasswordText:e.NewPassword,ConfirmPasswordText:e.ConfirmPassword,SaveButtonText:e.Save}),firmwareSetting:t.render(h,{CurPanelVersionText:e.CurPanelVersion,CurSystemVersionText:e.CurSystemVersion,UpdateButtonText:e.Update}),emailSetting:t.render(p,{HostEmailText:e.HostEmail,HostEmailPasswordText:e.HostEmailPassword,HostEmailServerText:e.HostEmailServer,HostServerText:e.HostServer,HostServerPortText:e.HostServerPort,EmailPrefixText:e.EmailPrefix,ReceiveEmailText:e.ReceiveEmail,SaveButtonText:e.Save}),wifiSetting:t.render(d,{CurWifiConnectionText:e.CurWifiConnection,RouterSettingText:e.RouterSetting,RouterNameText:e.RouterName,RouterPasswordText:e.RouterPassword,AvailableWifiText:e.AvailableWifi,WifiNameText:e.WifiName,WifiStrengthText:e.WifiStrength,EncryptionProtocolText:e.EncryptionProtocol,ConnectText:e.Connect,SaveButtonText:e.Save}),languageSetting:t.render(v,{SaveButtonText:e.Save})})},b});