define(["require","mustache","thirdLib/chart","lib/BrowserUtil","lib/DateTimeUtil","lib/InheritHelper","module/ThreejsRenderer","module/component/StatusCodeManager","module/agent/HomePageAgent","module/agent/FileManagePageAgent","module/interface/CentreContentPage","module/interface/kit/AlertBox","module/interface/kit/Loader","module/GlobalVar","text!../../../html/FileManagePage.html","text!../../../html/fileManagePage/DropZoneIcon.html","text!../../../html/fileManagePage/fileManageTable/TableHead.html","text!../../../html/fileManagePage/fileManageTable/TableBody.html","text!../../../html/fileManagePage/fileManageOperate/FileOperateModal.html","dataTable"],function(e){"use strict";function b(){this.superClass(),this._isUploading=!1,this._bindEvent(),this.active()}var t=e("mustache"),n=e("thirdLib/chart"),r=e("lib/BrowserUtil"),i=e("lib/DateTimeUtil"),s=e("lib/InheritHelper"),o=e("module/ThreejsRenderer"),u=e("module/component/StatusCodeManager"),a=e("module/agent/HomePageAgent"),f=e("module/agent/FileManagePageAgent"),l=e("module/interface/CentreContentPage"),c=e("module/interface/kit/AlertBox"),h=e("module/interface/kit/Loader"),p=e("module/GlobalVar"),d=e("text!../../../html/FileManagePage.html"),v=e("text!../../../html/fileManagePage/DropZoneIcon.html"),m=e("text!../../../html/fileManagePage/fileManageTable/TableHead.html"),g=e("text!../../../html/fileManagePage/fileManageTable/TableBody.html"),y=e("text!../../../html/fileManagePage/fileManageOperate/FileOperateModal.html");return e("dataTable"),s.inheritPrototype(b,l),b.prototype.INDEX=1,b.prototype.active=function(){var e=this;this._getCloudSpaceInfo(),this._refreshTabelHead(),$("#fileTableFooter").html(h.getDiv());if(p.debug){var t=[{fileName:"file1",fileSize:"110kb",fileContent:"no description",path:1,fileTime:"2015.11.26",isPC:!p.isMobile},{fileName:"file2",fileSize:"120kb",fileContent:"test file2",path:2,fileTime:"2015.11.26",isPC:!p.isMobile}];this.setFileTableBody(JSON.stringify(t)),this._resetTabelHeadStyle();return}f.queryFile("filelist",function(t){e.setFileTableBody(t),e._resetTabelHeadStyle()},function(t){e.notifyErrorMessage(t.status)})},b.prototype._resetTabelHeadStyle=function(){$("#fileTable").find("th").each(function(){$(this).removeAttr("style")})},b.prototype._refreshTabelHead=function(){var e=p.language.FileManagePage;$("#fileTableRow").html(t.render(m,{FileNameText:e.FileName,SizeText:e.Size,DescriptionText:e.Description,UploadDateText:e.UploadDate,OperationText:e.Operation,isPC:!p.isMobile}))},b.prototype.setFileTableBody=function(e){var n=p.language.FileManagePage,r=[],s=JSON.parse(e),o=null;for(var u=0,a=s.length;u<a;++u)o=s[u],r.push({name:o.fileName,size:o.fileSize,description:o.fileContent,date:i.getTimeZoneDate(o.fileTime),flag:o.path,source:this._getFileSourceLabel(o.path),OperationButtonText:n.Operation,isPC:!p.isMobile});$("#fileTableFooter").html(""),$("#fileTableBody").html(t.render(g,{fileItems:r}));if(!p.isMobile)try{$("#fileTable").DataTable({order:[[4,"desc"]]})}catch(f){console.error(f)}this._bindOperationButtonEvent()},b.prototype._getFileSourceLabel=function(e){var t="";switch(e){case 0:t="internal";break;case 1:t="SD";break;case 2:t="USB";break;default:t="??"}return t},b.prototype._bindOperationButtonEvent=function(){var e=this;$(".OperationButton").each(function(){$(this).click(function(t){e._onOperationButtonClick(t,$(this).closest("tr").data("filename"),$(this).closest("tr").data("flag"))})})},b.prototype._onOperationButtonClick=function(e,n,i){r.stopPropagation(e);var s=p.language.FileManagePage;$("#mainModalContent").html(t.render(y,{FileManageText:s.FileManage,DeleteButtonText:s.Delete,PreviewButtonText:s.Preview,PrintButtonText:s.Print,FileNameText:n})),this._bindFileOperateModalEvent(n,i),$("#mainModal").foundation("open")},b.prototype._bindFileOperateModalEvent=function(e,t){var n=this,r=p.language.AlertBox;$("#modal_DeleteFileButton").click(function(r){var i=[{filename:e,path:t}];f.operateFiles("/del/",i,function(e){$("#mainModal").foundation("close"),n.trigger("active")},function(e){n.notifyErrorMessage(e.status)})}),$("#modal_PreviewFileButton").click(function(r){$("#mainModalContent").html(h.getDiv());if(p.debug){$("#mainModalContent").html(""),null===p.threejsRenderer?(p.threejsRenderer=new o,p.threejsRenderer.init("mainModalContent"),p.threejsRenderer.render()):p.threejsRenderer.changeRenderViewDom("mainModalContent"),$("#mainModal").foundation("open");return}var i=e,s={filename:i.replace(".gcode",".stl"),path:t};f.previewFile(s,function(e){$("#mainModalContent").html(""),null===p.threejsRenderer?(p.threejsRenderer=new o,p.threejsRenderer.init("mainModalContent"),p.threejsRenderer.render()):p.threejsRenderer.changeRenderViewDom("mainModalContent"),p.threejsRenderer.loadStlModelByteArray(e),$("#mainModal").foundation("open")},function(e){n.notifyErrorMessage(e.status)})}),$("#modal_PrintFileButton").click(function(i){var s={filename:e,path:t};if(p.debug){$("#mainModal").foundation("close"),$(".centreContent").each(function(){$(this).hide()}),window.location.hash="#/home",$("#homePage").fadeIn();return}f.operateFiles("/print/",s,function(e){var t=JSON.parse(e);if(u.isOK(t.code)){$("#mainModal").foundation("close"),$(".centreContent").each(function(){$(this).hide()}),window.location.hash="#/home",$("#homePage").fadeIn();return}var n=new c(r.PrintFileError);$("body").append(n.getDiv())},function(e){n.notifyErrorMessage(e.status)})})},b.prototype._getCloudSpaceInfo=function(){var e=this;f.querySpace(function(e){var t=JSON.parse(e);$("#diskTotalSpace").html(t.total),$("#diskUsedSpace").html(t.used)},function(t){e.notifyErrorMessage(t.status)})},b.prototype._bindEvent=function(){},b.prototype.getContent=function(){var e=p.language.FileManagePage;return t.render(d,{FileManageText:e.FileManage,DropToUploadText:e.DropToUpload,TotalSpaceText:e.Total,UsedSpaceText:e.Used,ButtonUploadText:e.ButtonUploadText,DeleteButtonText:e.Delete,ExportButtonText:e.Export})},b});